CREATE OR REPLACE TRIGGER ATS_TRNSCTN_LOG_BRI 
    BEFORE INSERT OR DELETE OR UPDATE ON BKNG
    REFERENCING OLD AS OLD_BKNGROW NEW AS BKNGROW
    FOR EACH ROW
    BEGIN
IF(INSERTING AND :BKNGROW.ETS_APNTMT_ID IS NOT NULL AND (:BKNGROW.BKNG_STS_TYP_CDE = 'RSRVD' OR :BKNGROW.BKNG_STS_TYP_CDE = 'CNCL')) THEN
        INSERT INTO ATS_TRNSCTN_LOG (ATS_TRNSCTN_LOG_ID, TRNSCTN_STS_TYP_CDE, TRNSCTN_TYP_CDE, BKNG_ID, TST_TKR_TST_ID, FRM_ID, APNTMT_DT, TM_ZN_OFST_QTY, ETS_APNTMT_ID, EXTRNL_APNTMT_ID, BKNG_STS_TYP_CDE, 
DLVY_MDE_CDE, TST_CNTR_ID_NO, EVNT_OTCM_STS_TYP_CDE, CUST_FST_NAM, CUST_MID_NAM, CUST_LST_NAM, CUST_BRTH_DT, TST_LNCH_TM, TST_PKG_ID, TST_DURN, REGN_SYS_ID, CMNT, TST_ID, LANG_CDE, CREATED_BY_USER_ID, DATE_CREATED, BKNG_UPDATED_DATE) 
VALUES(ATS_TRNSCTN_LOG_ID_SEQ.NEXTVAL, 'NTSNT', DECODE(:BKNGROW.BKNG_STS_TYP_CDE, 'CNCL', 'CNCL', 'RSRVD', 'NEW'), :BKNGROW.BKNG_ID, :BKNGROW.TST_TKR_TST_ID, :BKNGROW.FRM_ID, :BKNGROW.APNTMT_DT ,:BKNGROW.TM_ZN_OFST_QTY, :BKNGROW.ETS_APNTMT_ID, :BKNGROW.EXTRNL_APNTMT_ID, 
:BKNGROW.BKNG_STS_TYP_CDE, :BKNGROW.DLVY_MDE_CDE, :BKNGROW.TST_CNTR_ID_NO, :BKNGROW.EVNT_OTCM_STS_TYP_CDE, :BKNGROW.CUST_FST_NAM, :BKNGROW.CUST_MID_NAM, :BKNGROW.CUST_LST_NAM, :BKNGROW.CUST_BRTH_DT, :BKNGROW.TST_LNCH_TM, :BKNGROW.TST_PKG_ID, :BKNGROW.TST_DURN, :BKNGROW.REGN_SYS_ID, :BKNGROW.CMNT, :BKNGROW.TST_ID, :BKNGROW.LANG_CDE, 1, SYSDATE, SYSDATE);
END IF;
IF UPDATING THEN  
IF(:BKNGROW.ETS_APNTMT_ID IS NOT NULL and :BKNGROW.EXTRNL_APNTMT_ID IS NOT NULL AND :OLD_BKNGROW.EXTRNL_APNTMT_ID IS NULL AND (:BKNGROW.BKNG_STS_TYP_CDE = 'RSRVD' OR :BKNGROW.BKNG_STS_TYP_CDE = 'CNCL')) THEN
INSERT INTO ATS_TRNSCTN_LOG (ATS_TRNSCTN_LOG_ID, TRNSCTN_STS_TYP_CDE, TRNSCTN_TYP_CDE, BKNG_ID, TST_TKR_TST_ID, FRM_ID, APNTMT_DT, TM_ZN_OFST_QTY, ETS_APNTMT_ID, EXTRNL_APNTMT_ID, BKNG_STS_TYP_CDE, 
DLVY_MDE_CDE, TST_CNTR_ID_NO, EVNT_OTCM_STS_TYP_CDE, CUST_FST_NAM, CUST_MID_NAM, CUST_LST_NAM, CUST_BRTH_DT, TST_LNCH_TM, TST_PKG_ID, TST_DURN, REGN_SYS_ID, CMNT, TST_ID, LANG_CDE, CREATED_BY_USER_ID, DATE_CREATED, BKNG_UPDATED_DATE ) 
VALUES(ATS_TRNSCTN_LOG_ID_SEQ.NEXTVAL, 'NTSNT', DECODE(:BKNGROW.BKNG_STS_TYP_CDE, 'CNCL', 'CNCL', 'RSRVD', 'NEW'), :BKNGROW.BKNG_ID, :BKNGROW.TST_TKR_TST_ID, :BKNGROW.FRM_ID, :BKNGROW.APNTMT_DT ,:BKNGROW.TM_ZN_OFST_QTY, :BKNGROW.ETS_APNTMT_ID, :BKNGROW.EXTRNL_APNTMT_ID, 
:BKNGROW.BKNG_STS_TYP_CDE, :BKNGROW.DLVY_MDE_CDE, :BKNGROW.TST_CNTR_ID_NO, :BKNGROW.EVNT_OTCM_STS_TYP_CDE, :BKNGROW.CUST_FST_NAM, :BKNGROW.CUST_MID_NAM, :BKNGROW.CUST_LST_NAM, :BKNGROW.CUST_BRTH_DT, :BKNGROW.TST_LNCH_TM, :BKNGROW.TST_PKG_ID, :BKNGROW.TST_DURN, :BKNGROW.REGN_SYS_ID, :BKNGROW.CMNT, :BKNGROW.TST_ID, :BKNGROW.LANG_CDE, 1, SYSDATE, SYSDATE);
ELSIF (:BKNGROW.ETS_APNTMT_ID IS NOT NULL) THEN
UPDATE ATS_TRNSCTN_LOG SET TRNSCTN_STS_TYP_CDE = DECODE(:BKNGROW.EVNT_OTCM_STS_TYP_CDE, 'CHI', 'NA', 'NTSNT'), TRNSCTN_TYP_CDE = DECODE(:BKNGROW.BKNG_STS_TYP_CDE, 'CNCL', 'CNCL', 'RSRVD', DECODE(:BKNGROW.EVNT_OTCM_STS_TYP_CDE, 'NOS', 'NOS', 'CNT', 'CNT', 'CHI', 'CHI', 'NCI', 'UPDTE')), BKNG_ID = :BKNGROW.BKNG_ID, TST_TKR_TST_ID = :BKNGROW.TST_TKR_TST_ID, FRM_ID = :BKNGROW.FRM_ID, APNTMT_DT = :BKNGROW.APNTMT_DT, TM_ZN_OFST_QTY = :BKNGROW.TM_ZN_OFST_QTY, ETS_APNTMT_ID = :BKNGROW.ETS_APNTMT_ID, EXTRNL_APNTMT_ID = :BKNGROW.EXTRNL_APNTMT_ID, BKNG_STS_TYP_CDE =  :BKNGROW.BKNG_STS_TYP_CDE, 
DLVY_MDE_CDE = :BKNGROW.DLVY_MDE_CDE, TST_CNTR_ID_NO = :BKNGROW.TST_CNTR_ID_NO, EVNT_OTCM_STS_TYP_CDE = :BKNGROW.EVNT_OTCM_STS_TYP_CDE, CUST_FST_NAM = :BKNGROW.CUST_FST_NAM, CUST_MID_NAM = :BKNGROW.CUST_MID_NAM, CUST_LST_NAM = :BKNGROW.CUST_LST_NAM, CUST_BRTH_DT = :BKNGROW.CUST_BRTH_DT, TST_LNCH_TM = :BKNGROW.TST_LNCH_TM, TST_PKG_ID = :BKNGROW.TST_PKG_ID, TST_DURN = :BKNGROW.TST_DURN, REGN_SYS_ID = :BKNGROW.REGN_SYS_ID, CMNT = :BKNGROW.CMNT,  TST_ID = :BKNGROW.TST_ID, LANG_CDE = :BKNGROW.LANG_CDE, BKNG_UPDATED_DATE = :BKNGROW.DATE_UPDATED, UPDATED_BY_USER_ID = 1, DATE_UPDATED = SYSDATE
WHERE ETS_APNTMT_ID = :BKNGROW.ETS_APNTMT_ID;
END IF;
END IF;
END ATS_TRNSCTN_LOG_BRI;

ALTER TRIGGER ATS_TRNSCTN_LOG_BRI ENABLE;
